from jax_transformer import (
    encoder,
    feedforward,
    normalization,
    positional_encoding,
    residual,
)

from jax import numpy as jnp, random as jrnd


def test_positional_encoding() -> None:
    assert jnp.allclose(
        positional_encoding.encode_position(
            jnp.zeros([13, 7], dtype=jnp.float32),  # odd number!
            jnp.ones([13], dtype=jnp.float32),
        ),
        jnp.stack(
            [
                jnp.array(
                    [
                        0.84147096,
                        0.54030228,
                        0.07190644,
                        0.99741137,
                        0.00517945,
                        0.99998659,
                        0.00037275,
                    ],
                    dtype=jnp.float32,
                )
                for _ in range(13)
            ]
        ),
    )


TEN_NORMALIZED = jnp.array(
    [
        [
            -1.5666989,
            -1.2185436,
            -0.87038827,
            -0.52223295,
            -0.17407766,
            0.17407766,
            0.52223295,
            0.87038827,
            1.2185436,
            1.5666989,
        ]
    ],
    dtype=jnp.float32,
)


def test_layer_norm() -> None:
    d_model = 10
    p = normalization.init(d_model)
    x = jnp.arange(d_model, dtype=jnp.float32)[jnp.newaxis]
    y = normalization.layer_norm(p, x)
    assert jnp.allclose(y, TEN_NORMALIZED)


def test_residual() -> None:
    d_model = 10
    p = residual.init(jnp.array(1, dtype=jnp.float64), d_model)
    x = jnp.arange(d_model, dtype=jnp.float32)[jnp.newaxis]
    y = residual.residual(p, x, lambda p, z: z + p.astype(jnp.float32))
    assert jnp.allclose(y, TEN_NORMALIZED)


def test_feedforward() -> None:
    d_model = 10
    d_ff = 20
    p = feedforward.init(jrnd.PRNGKey(42), d_model, d_ff)
    x = jnp.arange(d_model, dtype=jnp.float32)[jnp.newaxis]
    y = feedforward.feedforward(p, x)
    assert jnp.allclose(
        y,
        jnp.array(
            [
                [
                    -03.795891,
                    -06.430948,
                    -16.024843,
                    +06.165481,
                    -04.259849,
                    +06.478252,
                    +11.613619,
                    +09.119688,
                    -21.604553,
                    -02.048109,
                ]
            ],
            dtype=jnp.float32,
        ),
    )


def test_encoder() -> None:
    d_model = 10
    p = encoder.init(
        jrnd.PRNGKey(42),
        stack_depth=3,
        d_model=d_model,
        d_attn=20,
        heads=30,
        d_k=40,
        d_v=50,
        d_ff=60,
    )
    x = jnp.arange(42 * d_model, dtype=jnp.float32).reshape(42, d_model)
    y = encoder.encode(p, x, jnp.arange(42, dtype=jnp.float32))
    assert jnp.allclose(
        y,
        jnp.array(
            [
                [
                    0.72773135,
                    0.4484851,
                    -0.17946644,
                    -1.0938694,
                    -1.5472803,
                    -1.4452777,
                    0.7421434,
                    0.95186454,
                    -0.05277704,
                    1.4484463,
                ],
                [
                    0.52796525,
                    2.1085963,
                    -0.18931633,
                    -1.2286514,
                    0.5782324,
                    -0.91070455,
                    -0.24527396,
                    0.94853574,
                    -1.208796,
                    -0.3805872,
                ],
                [
                    0.21349904,
                    2.1582475,
                    -0.17835352,
                    -1.2359086,
                    0.60456294,
                    -0.9419635,
                    -0.22848095,
                    0.9231795,
                    -1.2555233,
                    -0.05925912,
                ],
                [
                    0.15261787,
                    2.166851,
                    -0.18661259,
                    -1.2349726,
                    0.60378736,
                    -0.9409609,
                    -0.23404746,
                    0.9127527,
                    -1.2582778,
                    0.01886242,
                ],
                [
                    0.1255493,
                    2.171953,
                    -0.1783882,
                    -1.2368935,
                    0.6166393,
                    -0.9419484,
                    -0.23930456,
                    0.8971797,
                    -1.254528,
                    0.03974166,
                ],
                [
                    0.09654532,
                    2.1797132,
                    -0.17099233,
                    -1.237354,
                    0.60284805,
                    -0.9394457,
                    -0.23908879,
                    0.8869145,
                    -1.2582611,
                    0.0791207,
                ],
                [
                    0.06214226,
                    2.1875644,
                    -0.17406285,
                    -1.232477,
                    0.5579297,
                    -0.9302201,
                    -0.2341788,
                    0.88808584,
                    -1.2725692,
                    0.1477856,
                ],
                [
                    0.0290302,
                    2.191593,
                    -0.18507454,
                    -1.2186991,
                    0.5057933,
                    -0.9139284,
                    -0.23241706,
                    0.9003115,
                    -1.2937465,
                    0.2171374,
                ],
                [
                    0.01060497,
                    2.191649,
                    -0.19643024,
                    -1.2062391,
                    0.47569355,
                    -0.90094453,
                    -0.23419653,
                    0.91216916,
                    -1.3085866,
                    0.25628036,
                ],
                [
                    0.00817096,
                    2.1914823,
                    -0.20091331,
                    -1.2022318,
                    0.4767579,
                    -0.8968254,
                    -0.23792915,
                    0.91533184,
                    -1.3112305,
                    0.25738674,
                ],
                [
                    0.01077911,
                    2.1930711,
                    -0.19716774,
                    -1.2031311,
                    0.49352676,
                    -0.8975988,
                    -0.24245381,
                    0.91102415,
                    -1.3071865,
                    0.23913656,
                ],
                [
                    0.00760589,
                    2.1958747,
                    -0.19052702,
                    -1.2027082,
                    0.502567,
                    -0.89700544,
                    -0.2459815,
                    0.90606856,
                    -1.3053566,
                    0.22946265,
                ],
                [
                    -0.00427652,
                    2.1986952,
                    -0.1874888,
                    -1.1977903,
                    0.49214223,
                    -0.89162856,
                    -0.24755362,
                    0.9061571,
                    -1.3105538,
                    0.24229704,
                ],
                [
                    -0.01918815,
                    2.1999462,
                    -0.1902611,
                    -1.1897101,
                    0.46910033,
                    -0.8830669,
                    -0.24759707,
                    0.91156244,
                    -1.3203993,
                    0.269614,
                ],
                [
                    -0.02885858,
                    2.199358,
                    -0.19581436,
                    -1.1828091,
                    0.45047805,
                    -0.87604654,
                    -0.24753234,
                    0.918029,
                    -1.3285542,
                    0.29175022,
                ],
                [
                    -0.02988369,
                    2.1986625,
                    -0.199107,
                    -1.1806116,
                    0.44801557,
                    -0.87386346,
                    -0.24849209,
                    0.92076737,
                    -1.3305997,
                    0.2951115,
                ],
                [
                    -0.02609986,
                    2.199231,
                    -0.19752032,
                    -1.1823672,
                    0.4586627,
                    -0.87555885,
                    -0.25038388,
                    0.9185479,
                    -1.3274873,
                    0.28297633,
                ],
                [
                    -0.02448401,
                    2.2008438,
                    -0.19287215,
                    -1.1841229,
                    0.4688804,
                    -0.87726015,
                    -0.25224748,
                    0.91450703,
                    -1.3242102,
                    0.27096543,
                ],
                [
                    -0.02900786,
                    2.202579,
                    -0.1893694,
                    -1.1827141,
                    0.4674175,
                    -0.8757595,
                    -0.2531929,
                    0.9128893,
                    -1.3251655,
                    0.2723233,
                ],
                [
                    -0.03768052,
                    2.203412,
                    -0.18969174,
                    -1.1781546,
                    0.454477,
                    -0.8710996,
                    -0.25308388,
                    0.91524,
                    -1.3304377,
                    0.28701884,
                ],
                [
                    -0.04485848,
                    2.2029665,
                    -0.19293079,
                    -1.1732568,
                    0.44028544,
                    -0.8662691,
                    -0.2526177,
                    0.91951376,
                    -1.3362355,
                    0.3034025,
                ],
                [
                    -0.04650557,
                    2.2021618,
                    -0.19576435,
                    -1.1711514,
                    0.4353986,
                    -0.8643269,
                    -0.2526929,
                    0.9221736,
                    -1.3385972,
                    0.3093046,
                ],
                [
                    -0.04360301,
                    2.2021563,
                    -0.19551313,
                    -1.1723697,
                    0.44145185,
                    -0.86563224,
                    -0.2535766,
                    0.9213302,
                    -1.3368021,
                    0.30255836,
                ],
                [
                    -0.04081854,
                    2.2030876,
                    -0.1924419,
                    -1.1744747,
                    0.45047975,
                    -0.8677873,
                    -0.2547589,
                    0.9183168,
                    -1.333713,
                    0.29211062,
                ],
                [
                    -0.04215645,
                    2.2042985,
                    -0.1893039,
                    -1.1745952,
                    0.4527481,
                    -0.8679638,
                    -0.25550008,
                    0.9162518,
                    -1.333032,
                    0.28925326,
                ],
                [
                    -0.04757761,
                    2.2049637,
                    -0.18869151,
                    -1.1719143,
                    0.44534773,
                    -0.86535347,
                    -0.25546426,
                    0.9171024,
                    -1.3359752,
                    0.29756242,
                ],
                [
                    -0.0533357,
                    2.2046387,
                    -0.19079731,
                    -1.1681234,
                    0.43414208,
                    -0.8617344,
                    -0.25498426,
                    0.92011225,
                    -1.3404139,
                    0.3104958,
                ],
                [
                    -0.05555449,
                    2.2038038,
                    -0.19346869,
                    -1.1658783,
                    0.42799506,
                    -0.859739,
                    -0.25475115,
                    0.92270976,
                    -1.3430417,
                    0.31792462,
                ],
                [
                    -0.05367979,
                    2.203424,
                    -0.19424589,
                    -1.166371,
                    0.43076992,
                    -0.86040837,
                    -0.25517616,
                    0.922842,
                    -1.342356,
                    0.31520134,
                ],
                [
                    -0.05072173,
                    2.2038703,
                    -0.19254807,
                    -1.1682613,
                    0.43822432,
                    -0.86239076,
                    -0.25603366,
                    0.9207728,
                    -1.3398287,
                    0.3069172,
                ],
                [
                    -0.05034589,
                    2.204728,
                    -0.19007881,
                    -1.1691078,
                    0.44235143,
                    -0.86331856,
                    -0.2567354,
                    0.9187183,
                    -1.3384349,
                    0.30222377,
                ],
                [
                    -0.0536323,
                    2.205296,
                    -0.18915075,
                    -1.1676146,
                    0.43870714,
                    -0.8619303,
                    -0.25686827,
                    0.9187156,
                    -1.3399255,
                    0.30640334,
                ],
                [
                    -0.05827541,
                    2.2050881,
                    -0.19058867,
                    -1.1646264,
                    0.43006963,
                    -0.85911936,
                    -0.25653112,
                    0.9208396,
                    -1.3433362,
                    0.31647968,
                ],
                [
                    -0.06083808,
                    2.2043061,
                    -0.19311689,
                    -1.1622949,
                    0.42353398,
                    -0.8570256,
                    -0.2562417,
                    0.9233008,
                    -1.3460466,
                    0.32442296,
                ],
                [
                    -0.05989213,
                    2.203724,
                    -0.19460356,
                    -1.1621366,
                    0.4239842,
                    -0.8570391,
                    -0.2564492,
                    0.92410636,
                    -1.3462018,
                    0.32450753,
                ],
                [
                    -0.05716658,
                    2.2038472,
                    -0.19398798,
                    -1.1636355,
                    0.429854,
                    -0.8585942,
                    -0.2571239,
                    0.9228389,
                    -1.3442913,
                    0.31825912,
                ],
                [
                    -0.05582185,
                    2.2044773,
                    -0.19217382,
                    -1.1648309,
                    0.4348928,
                    -0.85980314,
                    -0.25782722,
                    0.9209678,
                    -1.3425952,
                    0.312714,
                ],
                [
                    -0.05757268,
                    2.2050235,
                    -0.19111009,
                    -1.1641923,
                    0.43400753,
                    -0.8592,
                    -0.2581288,
                    0.9204181,
                    -1.343064,
                    0.31381866,
                ],
                [
                    -0.06124477,
                    2.204978,
                    -0.19197516,
                    -1.1619068,
                    0.4277146,
                    -0.8570116,
                    -0.25797388,
                    0.92181253,
                    -1.3455786,
                    0.32118574,
                ],
                [
                    -0.06396551,
                    2.2043462,
                    -0.1941807,
                    -1.1596276,
                    0.42136636,
                    -0.85488343,
                    -0.25771758,
                    0.9240193,
                    -1.3481812,
                    0.3288243,
                ],
                [
                    -0.06382464,
                    2.2037172,
                    -0.1959823,
                    -1.1589781,
                    0.4201653,
                    -0.85433835,
                    -0.2577996,
                    0.9252315,
                    -1.3489212,
                    0.3307303,
                ],
                [
                    -0.06155127,
                    2.2036545,
                    -0.19607058,
                    -1.1600596,
                    0.42448214,
                    -0.8554027,
                    -0.25832,
                    0.92459726,
                    -1.3475848,
                    0.326255,
                ],
            ],
            dtype=jnp.float32,
        ),
    )
